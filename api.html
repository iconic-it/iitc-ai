<div id="chatbot" style="max-width: 800px; margin: 20px auto; font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); border-radius: 12px; overflow: hidden; background-color: #1e1e1e;">
    <div style="background: linear-gradient(135deg, #2a3f5f 0%, #1a365d 100%); color: white; padding: 16px; font-size: 18px; font-weight: 600;">
        IITC ChatBot
    </div>
    <div id="messages" style="height: 400px; overflow-y: auto; padding: 16px; background-color: #252525; display: flex; flex-direction: column; gap: 12px;"></div>
    <div style="display: flex; gap: 8px; padding: 16px; background-color: #2d2d2d; border-top: 1px solid #3a3a3a;">
        <input type="text" id="userInput" placeholder="Type your message here..." 
               style="flex-grow: 1; padding: 12px 16px; border: 1px solid #3a3a3a; border-radius: 24px; outline: none; font-size: 14px; transition: all 0.3s ease; background-color: #3a3a3a; color: #e0e0e0;"
               onfocus="this.style.borderColor='#4a7dff'; this.style.backgroundColor='#424242'"
               onblur="this.style.borderColor='#3a3a3a'; this.style.backgroundColor='#3a3a3a'">
        <button id="sendButton" style="padding: 12px 24px; background: linear-gradient(135deg, #2a3f5f 0%, #1a365d 100%); color: white; border: none; border-radius: 24px; cursor: pointer; font-weight: 500; font-size: 14px; transition: all 0.2s ease;"
                onmousedown="this.style.transform='scale(0.98)'; this.style.opacity='0.9'"
                onmouseup="this.style.transform='scale(1)'; this.style.opacity='1'"
                onmouseleave="this.style.transform='scale(1)'; this.style.opacity='1'">
            Send
        </button>
    </div>
</div>

<style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes typingAnimation {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-5px); }
    }
</style>

<script>
    // Initialize message history array
    let messageHistory = [];
    const INFO_KEYWORDS = ['who is', 'what is', 'tell me about', 'explain', 'information about', 'details about'];
    const MAX_WIKI_LENGTH = 500; // Limit Wikipedia response length

    async function fetchAIResponse(userMessage) {
        const apiKey = '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';
        const apiUrl = 'https://openrouter.ai/api/v1/chat/completions';

        // Check if this appears to be an informational query
        const isInfoQuery = INFO_KEYWORDS.some(keyword => 
            userMessage.toLowerCase().includes(keyword)
        );

        if (isInfoQuery) {
            try {
                const searchTerm = extractSearchTerm(userMessage);
                if (searchTerm) {
                    const wikiData = await fetchWikipediaData(searchTerm);
                    if (wikiData) {
                        // Add context to message history
                        messageHistory.push({
                            role: "assistant",
                            content: `Here's what I found about ${searchTerm}: ${wikiData}`
                        });
                        return `Here's what I found:\n${wikiData}`;
                    }
                }
            } catch (error) {
                console.error('Wikipedia fetch failed:', error);
                // Fall through to normal AI response
            }
        }

        // Normal AI response flow
        messageHistory.push({
            role: "user",
            content: userMessage
        });

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'My Chat App'
                },
                body: JSON.stringify({
                    model: "openai/gpt-3.5-turbo",
                    messages: messageHistory,
                    temperature: 0.7
                }),
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
            }

            const data = await response.json();
            const aiResponse = data.choices[0]?.message?.content || "No response content found";
            
            messageHistory.push({
                role: "assistant",
                content: aiResponse
            });

            return aiResponse;
        } catch (error) {
            console.error('API Error:', error);
            return `Error: ${error.message}`;
        }
    }

    function extractSearchTerm(message) {
        // Find the most likely search term by looking after info keywords
        for (const keyword of INFO_KEYWORDS) {
            if (message.toLowerCase().includes(keyword)) {
                const startIndex = message.toLowerCase().indexOf(keyword) + keyword.length;
                return message.substring(startIndex).trim();
            }
        }
        return message.trim(); // Fallback to entire message
    }

    async function fetchWikipediaData(searchTerm) {
        const wikiApiUrl = `https://en.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=extracts&exintro&explaintext&redirects=1&titles=${encodeURIComponent(searchTerm)}`;

        const response = await fetch(wikiApiUrl);
        const data = await response.json();
        const pages = data.query.pages;
        const pageId = Object.keys(pages)[0];
        
        if (pageId === "-1") return null; // No page found
        
        let extract = pages[pageId].extract;
        if (extract.length > MAX_WIKI_LENGTH) {
            extract = extract.substring(0, MAX_WIKI_LENGTH) + '...';
        }
        return extract;
    }
</script>
<script src="java_api.js"></script>
